{% extends 'healthseeker/base.html' %}
{% load static %}

{% block content %}
<style>
    .h40 {
        height: 32px !important;
    }

    .manual {
        display: none;
    }
</style>
<script src="{% static 'common/js/all.js' %}"></script>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDMCBCYMwsj0JQowT1a4GMNtYJqVEPqxVc&libraries=places"></script>
<script>
        let makeRequest = (obj) => {
            var place = obj.place || "", latLong = obj.latLong;
            let setPlace = (place) => {
                place = placeToJSON(place);
                $.ajax({
                    url: window.location.pathname,
                    method: "POST",
                    data: {
                        place: place,
                    },
                    success: function(response) {
                        alert("Location" + ((response.status)? " " : " not ") + "updated successfully!");
                        $("pre#id_place").text(JSON.stringify(response, null, 4));
                        $("pre#id_place").fadeIn();
                        if(response['status']) $("pre#id_place").css({ 'color' : 'black', });
                        else $("pre#id_place").css({ 'color' : 'red', });
                        setTimeout(() => { $("pre#id_place").fadeOut(); }, 5000);
                    }
                });
            };
            if(latLong) {
                let geocoder = new google.maps.Geocoder;
                geocoder.geocode({'location': latLong }, function(results, status) {
                    if (status === google.maps.GeocoderStatus.OK) setPlace(results[0]);
                    else alert('Geocoder failed due to: ' + status + '! Please add manually!');
                });
            }
            else setPlace(place);
        };
</script>

<section class="form_reg_one_hero">
            <div class="container">
                <div class="row">
                    <div class="col-md-12">
                        <div class="full_width form_reg_one">

                            <div class="header_form">
                                <div class="form_reg_one_in">
                                  <div class="progress"><div class="progress-bar progress-bar-striped progress-bar-animated" style="width:40%"></div></div>
                                </div>

                            </div>

                            <a href="{% url 'healthseeker:step5' %}" class="skipt0page"><i class="fa fa-share"></i> &nbsp;Skip this page</a>
                           <div class="row">

             <div class="col-md-12">
                <div class="panel panel-info">
                 <div class="panel-heading">Health Seeker</div>
                    <div class="panel-wrapper collapse in" aria-expanded="true">
                         <div class="panel-body">
                          <div class="form-body">
                        <h3 class="box-title">Contact Details</h3>

                       <div class="row">
                            <div class="col-sm-12">
                                <div class="white-box">
                                        <div class="form-group ">
                                            <label class="radio-inline">
                                                <input type="radio" name="location_type" class="ltype" value=".current" checked>Current Location
                                            </label>
                                            <label class="radio-inline">
                                                <input type="radio" name="location_type" class="ltype" value=".manual">Update Manually
                                            </label>
                                        </div>
                                        <br>
                                        <div class="current location_sections">

                                            <ul class="nav nav-tabs">
                                                <li>
                                                    <a data-toggle="tab" href="#geo">Current Location</a>
                                                </li>
                                                <li class="active">
                                                    <a data-toggle="tab" href="#map">Enter Your Location</a>
                                                </li>
                                            </ul>
                                            <div class="tab-content">
                                                <div id="geo" class="tab-pane fade">
                                                    <div class="getlocation" style="cursor: pointer;">
                                                        <p id="demo">Click the button to get your position.</p>


                                                        <script src="https://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript">
function showPosition(){
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(showMap, showError);
    } else{
        alert("Sorry, your browser does not support HTML5 geolocation.");
    }
}

// Define callback function for successful attempt
function showMap(position){
    // Get location data
    lat = position.coords.latitude;
    long = position.coords.longitude;
    var latlong = new google.maps.LatLng(lat, long);

    var myOptions = {
        center: latlong,
        zoom: 16,
        mapTypeControl: true,
        navigationControlOptions: {style:google.maps.NavigationControlStyle.SMALL}
    }

    var map = new google.maps.Map(document.getElementById("embedMap"), myOptions);
    var marker = new google.maps.Marker({position:latlong, map:map, title:"You are here!"});
}

// Define callback function for failed attempt
function showError(error){
    if(error.code == 1){
        result.innerHTML = "You've decided not to share your position, but it's OK. We won't ask you again.";
    } else if(error.code == 2){
        result.innerHTML = "The network is down or the positioning service can't be reached.";
    } else if(error.code == 3){
        result.innerHTML = "The attempt timed out before it could get the location data.";
    } else{
        result.innerHTML = "Geolocation failed due to unknown error.";
    }
}
</script>
</head>
<body>
    <button type="button" onclick="showPosition();">Get My Current Location</button>
    <div id="embedMap" style="width: 400px; height: 300px;">
        <!--Google map will be embedded here-->
    </div>
</body>


                                                    </div>
                                                </div>
                                                <div id="map" class="tab-pane fade  in active">
                                                    <div class="form-horizontal" style="width: 550px">
                                                        <div class="form-group">
                                                            <label class="col-sm-2 control-label">Location:</label>
                                                            <div class="col-sm-10">
                                                                <input type="text" class="form-control" id="clickhealth_address" />
                                                            </div>
                                                        </div>
                                                        <div class="clearfix">&nbsp;</div>
                                                        <div class="m-t-small" style="display:none">
                                                            <label class="p-r-small col-sm-1 control-label">Lat.:</label>

                                                            <div class="col-sm-3">
                                                                <input type="text" class="form-control" style="width: 110px" name="longitude" id="clickhealth_lat" />
                                                            </div>
                                                            <label class="p-r-small col-sm-2 control-label">Long.:</label>

                                                            <div class="col-sm-3">
                                                                <input type="text" class="form-control" style="width: 110px" name="latitude" id="clickhealth_lon" />
                                                            </div>
                                                        </div>
                                                        <div class="clearfix"></div>
                                                        <script>
                                                            var place = "";
                                                            var input = document.getElementById('clickhealth_address');
                                                            autocomplete = new google.maps.places.Autocomplete(input, {
                                                                    types: ['geocode']
                                                                });
                                                            autocomplete.addListener('place_changed', function () {
                                                                place = autocomplete.getPlace();
                                                                makeRequest({ 'place' : place });
                                                            });
                                                        </script>

                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="manual location_sections">


                                            <select name="country" class="form-control  countries order-alpha" id="countryId">
                                                    <option value="">Select Country</option>
                                                </select><br><br>
                                                <select name="state" class="states form-control h40 order-alpha" id="stateId">
                                                    <option value="">Select State</option>
                                                </select><br><br>
                                                <select name="city" class="cities form-control h40 order-alpha  limit-pop-10000" id="cityId">
                                                    <option value="">Select City</option></select>
                                                <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
                                                <script src="//geodata.solutions/includes/countrystatecity.js"></script>
                                        </div><br>
                                            <div class="form-group">
                                                <label for="id_area">Area:</label>
                                                <br>
                                                <input type="text" name="area" maxlength="200" class="form-control h40" placeholder="area" id="id_area" />
                                            </div>
                                        </div>
                                        <br>
                                        <div class="row">
                                            <div class="col-md-12">
                                                <br>
                                                <div class="row">
                                                    <div class="form-group col-md-12">
                                                        <div class="icon-addon addon-md">
                                                            <pre id="id_place"></pre>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <br>
                                    </div>
                                </div></div>
                          <ul class="save_next">
                            <li><a class="save_inf" href="{% url 'healthseeker:step5' %}">Next</a></li>
                            <li><a class="next_inf" href="{% url 'healthseeker:step3' %}">Back</a></li>
                         </ul>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
 </div>
</section>
    <script>
        $(document).ready(function () {
            $("div.location_sections").hide();
            $("div.current").fadeIn();

            $(".ltype").click(function () {
                let radioValue = $("input[name='location_type']:checked").val();
                $("div.location_sections").hide();
                $(radioValue).fadeIn();
            });

            $(".getlocation").click(function () {
                if ("geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(function (position) {
                        $("#clickhealth_lat").val(position.coords.latitude);
                        $("#clickhealth_lon").val(position.coords.longitude);
                        let latLong = {
                            'lat' : position.coords.latitude,
                            'lng' : position.coords.longitude,
                        };
                        makeRequest({ 'latLong' : latLong });
                    });
                } else
                    alert("Browser doesn't support geolocation!");
            });
        });
    </script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="http://lab.iamrohit.in/js/location.js"></script>
    {% endblock %}



